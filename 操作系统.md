# 操作系统笔记

## 第一章 操作系统概论

#### 操作系统的概念

##### 一、计算机系统

定义：计算机系统是一种可以按照用户的要求接收和存储信息、自动进行数据处理并输出结果信息的系统

分类：广义：机械式系统和电子式系统(模拟式和数字式计算机系统)

组成：硬件(子)系统和软件(子)系统

资源：硬件资源、软件资源 

在计算机系统中，集中了<font color="red">资源管理功能和控制程序执行功能</font>的一种<font color="red">软件</font>，称为<font color="red">操作系统</font>

1. 组织和管理计算机系统中的硬件资源和软件资源

   在操作系统中，设计了各种表格或数据结构，将所有的软硬件资源都加以登记，例如PCB、系统设备等

2. 有效

   操作系统在管理计算机资源时考虑到系统运行的效率和利源的利用率，尽可能的提高中央处理器的利用率，让他尽可能少的空转，应保证访问效能的前提下尽可能的有效利用其他资源。例如：减少内存、磁盘空间的浪费

3. 合理

   公平的对待不同的用户程序，保证不发生死锁好饥饿的现象

4. 方便

   操作系统的人机界面要考虑到用户使用洁面和程序接口的易用性，易学性和易维护性(用户使用、程序员使用)

操作系统的

##### 二、操作系统的特征

1. 并发性

   指计算机系统同时存在着若干个运行着的程序，从宏观上看，这些程序同时向前推进

2. 共享性

   操作系统需与多个用户程序公用系统中的各种资源，如：CPU、内存、外部设备等

3. 随机性(异步性)

   操作系统不能对所运行的程序的行为以及硬件设备的情况做出任何事先的假定

2. 操作系统的观点

   1. 软件的观点

      操作系统是一种大型的系统软件，他是多种功能程序的集合，有外在特性：接口 和内在特性：与硬件交互

   2. 资源管理的观点

      操作系统登记谁在使用资源、哪些资源是空闲的、响应了对谁的资源的请求、以及回首那些不再使用的资源

   3. 进程的观点

      把操作系统看作由多个可以同时独立运行程序和一个对这些程序进行协调的核心

   4. 虚拟机的观点

      用户不需要操作硬件，而是通过操作系统提供的各种手段来控制和使用计算机

   5. 服务提供的观点

      提供了比裸机功能更强、服务质量更高的虚拟机

##### 三、操作系统的功能

1. 进程管理

   对中央处理器进行管理(称为处理机管理)

   进程的引入：<font color="red">为了描述多道程序的并发而引入</font>

   进程简单的定义：一个程序的运行过程

   进程管理的内容：进程控制、进程的同步、进程间通信、调度

2. 存储管理

   管理计算机内存的资源

   功能：

   1. 内存的分配与回收：多个程序共享有限的内存资源时，要考虑如何为多个程序分配有限的内存空间，以及程序运行完毕还需要内存回收
   2. 存储保护：存储在内存中的多个程序和数据隔离、互不侵扰
   3. 内存扩充：将辅助存储器作为内存扩充空间

3. 文件管理

   有效的支持文件的存储、检索和修改等操作、解决文件的共享、保密和保护问题，以便用户方便、安全的访问文件

   功能：文件存储空间的管理、目录管理、文件系统的安全性

4. 设备管理

   除了处理器和内存外的所有的输入输出设备的管理(启动、分配、故障处理)

   中断技术、通道技术、虚拟设备技术、缓冲技术 充分发挥设备的能力

5. 用户接口

   操作系统就是用户与计算机之间的接口

##### 四、操作系统的体系结构

1. windows系统

   1. 内核
   2. 硬件抽象层HAL(系统可移植性的部分)
   3. 执行体
   4. 系统进程和系统线程

2. UNIX

   1. 内核层：提供了与硬件的接口、shell的接口，分为两部分：进程控制子系统和文件子系统
   2. 系统层：内核层和应用层之间，供程序员开发调用，包括进程管理、文件管理、中断状态
   3. 应用层：面向用户操作的界面

3. LInux

   四个部分：内核、shell、文件系统、应用程序

4. Android

   从低到高：应用程序层、应用框架层、系统运行库层、Linux内核层

##### 五、操作系统发展过程

1. 手工阶段
2. 监控程序
3. 多道批处理
4. 分时与实时操作系统
5. UNINX通用操作系统
6. 个人计算机操作系统
7. Android操作系统

##### 六、操作系统的分类

1. 批处理操作系统

   由人工(系统操作员操作)

   特点：成批操作、用户不能干预自己作业的运行

   目标：提高资源利用率、作业吞吐率高

   分类：简单批处理、和多道批处理

   1. 一般指令和特权指令
      1. 用户模式和特权模式
      2. 目态和管态
      3. 一般指令和特权指令
      4. 系统调用：用户程序不能直接使用特权指令，向操作系统请求这些功能，这些功能通过系统调用完成
   2. 系统调用的过程：首先由中断或异常处理程序把控制流程转移到监控程序内的一些特殊位置，处理器模式转为特权模式，其次由监控程序执行被请求的功能，最后，恢复现场，运行模式转变为用户模式，控制权交给用户程序
   3. SPOOLing技术(假脱机技术)

2. 分时操作系统

   1. 一台主机连接了多个终端，每个终端都可以向系统提出请求
   2. 特点：<font color="red">多路性、交互性、独占性、及时性</font>

3. 实时操作系统

   1. 严格时间内，对目标返回，必须有高可靠性
   2. 硬实时系统和软实时系统
   3. 实时时钟管理、过载保护、高可靠性

4. 嵌入式操作系统

   1. 运行在嵌入式芯片环境中、微型化、实时性

##### 七、操作系统的设计

1. 功能设计
2. 算法设计
3. 结构设计
4. 设计目标：可靠性、高效性、易维护性、可移植性、安全性、简明性
5. 结构研究目标：系统模块化、模块标准化、通信规范化

##### 八、操作系统的结构

1. 整体式结构
2. 层次式结构
3. 微内核(客户/服务器)结构









## 第三章 进程与线程

#### 程序的顺序执行

##### 一、程序的顺序执行

1.  含义：程序在一个时间上按照严格次序前后相继操作序列，

   一个具有独立功能的程序<font color="red">独占处理器</font>直到得到最终结果的过程成为程序的顺序执行

2. 特点

   1. 顺序性

      程序所规定的动作在机器上严格的按顺序执行

   2. 封闭性

      程序运行后，其计算结果只取决于程序本身，结果由初始条件决定，不收外界因素影响 

   3. 程序执行结果的确定性

      程序执行结果与其执行速度无关

   4. 程序执行结果可再现性

      如果程序再次执行，只要其初始条件相同，则结果就会相同

##### 二、程序的并发执行 

​	所谓并发就是指两个及以上的程序在计算机系统中同时处于开始执行且尚未结束的状态。

​	能够参与并发执行的程序成为并发程序，他的执行和顺序执行特征不同

1. 在并发执行期间，并发程序相互制约(抢夺CPU等资源)
2. 程序与计算不再一一对应(允许多个程序共享一个程序段)
3. 执行结果不可再现
4. 并发执行和并行执行是有区别的 并发执行时宏观上的同时执行，并行执行时微观上的同时 比如CPU同时执行两个程序

##### 三、多道程序设计

​	将多个程序同进入内存并运行。根本目的是提高整个系统的效率

​	吞吐量：指单位时间内系统所处理进程的道数，是衡量系统效率的尺度

1. 特点：
   1. 独立性
   2. 随机性
   3. 资源共享性
   4. 缺陷：
      可能会延长程序的执行时间，系统效率提高有一定的限度

#### 进程

##### 一、进程的含义

​	进程是具有一定独立功能的程序在某个数据集合上的一次运行活动，是 <font color="red">系统进行资源分配 </font> 和 <font color="red">调度的一个独立单位</font>

​	分为系统进程和用户进程

1. 进程和程序的联系

   程序是构成进程的重要组成部分之一，一个进程执行目标是执行它所对应的程序

   进程=程序+数据+进程控制卡(PCB)

2. 区别

   程序是静态的，进程是动态的 

   二者是多对多的关系(一个程序可以生产多个进程 一个进程可以运行多个程序)

##### 二、可再入程序

​	一个能够被多个用户同时调用的程序成为可再入程序

1. 必须是纯代码，执行过程中不能修改自己的代码 
2. 必须与数据区隔离(如操作系统、编译程序、他们能被不同用户调用形成不同的进程)

##### 三、特征

并发性、动态性、独立性、交往性、异步性、结构性 

##### 四、进程模型

1. 三状态模型

   运行状态、就绪状态(等待CPU)、等待状态(运行过程中发生了事件阻塞)

   等待状态不能逆向运行状态，就绪状态不能逆向等待

   就绪《-》允许-》等待-》就绪

##### 五、进程控制块PCB

​	操作系统核心中定义了一个专门的数据结构，成为PCB

​	<font color="red">PCB是进程存在的唯一标志</font>，当系统创建一个进程时，为进程设置一个PCB，再利用进程进行控制管理，撤销进程时，系统收回PCB，进程也随之消亡

1. PCB的内容

   1. 调度信息：包括进程名，进程号，地址空间信息，优先级，当前状态，家族关系，消息队列指针、进程队列指针、和当前打开文件等
   2. 现场信息：刻画了进程的运行情况，主要是CPU寄存器的信息，如程序中断时，需要保存现场信息

2. 进程的组成

   1. 进程由程序、数据、进程控制块组成
   2. ​	<font color="red">PCB是灵魂 </font> 程序和数据是躯体

3. PCB组织

   1. 线性方式
   2. 索引方式
   3. 链接方式

4. 进程的队列

   就绪队列、等待队列、运行队列

   进程队列实际上就是PCB的链接，分为双向链表和单向链表(出队、入队、插队)

##### 六、进程控制

​	进程控制：对进程整个生命周期中的各种状态之间的转换进行控制，由原语来实现。

​	原语：由若干个指令组成，是一个不可分割的基本单位，不会被打断，原子操作在系统态下执行

1. 进程控制原语：

   创建、撤销、阻塞、唤醒

#### 线程

##### 一、线程的基本概念

1. 线程是进程中的一个实体，是处理器调度和分配的基本单位
2. 一个线程可以创建和撤销另一个线程，同一个线程中的多个线程可以并发执行
3. 线程的属性
   1. 每一个线程有一个唯一的标识符和一张线程描述表
   2. 不同线程可以执行相同的程序
   3. 同一个进程中的各个线程共享该进程的内存地址空间
   4. 线程是处理器的独立调度单位，多个线程可以并发执行
   5. 一个线程具有生命周期
4. 引入线程的好处
   1. 创建线程花费时间少
   2. 线程之间切换花费时间少
   3. 线程之间通信无需内核，不需要额外的通信机制，使通信简单，信息传送速度快

##### 二、进程和线程的比较

1. 调度

   线程作为调度的基本单位，同进程中，线程切换不引起进程切换，当不同的进程的线程切换时才引起进程的切换

2. 并发性

   一个进程间的多个线程可并发，不同进程的多个线程也可以并发执行

3. 拥有资源

   线程仅拥有进程的资源，<font color="red">进程拥有资源的独立单位</font>

4. 系统开销

   线程低，进程高

##### 三、线程实现机制

1. 用户级线程

   仅存用户空间，由用户层的线程库提供现成的创建、撤销、切换、以及线程之间的同步与通信等的支持，而无需内核的支持。

2. 内核级线程

   由os直接支持，更灵活、更方便

3. 混合方式

##### 四、进程调度

1. 进程调度的主要功能

   1. 记录所有的进程的执行状态
   2. 根据一定的调度算法，从就绪队列选出一个进程，准备将CPIU分配给他
   3. 分配CPU

2. 进程调度的时机

   ###### 正在执行的进程完毕、进程阻塞、创建新的进程、等待的进程激活了、时间片完、进程出错了

3. 进程调度的方式

   1. 抢占式调度

      允许调度程序根据某种原则，去暂停某个正在执行的进程，将已分配的CPU分配给另一个进程

      抢占方式能够满足实时任务的需求，但是比较复杂且开销大

   2. 非抢占式调度

      一旦分配某个进程之后，就不会因为其他例如：时钟中断、或其他的非程序本身原因去抢占该正在运行进程的处理机，直到该进程完成或进程被阻塞 才会把处理机分配给其他进程

4. 调度算法设计原则

   1. 进程行为

      I/O密集型和计算密集型

   2. 系统分类

      批处理、实时系统、交互系统

   3. 调度算法的设计目标

      共同目标：资源利用率高，公平，平衡，强制执行策略

      批处理目标：平均周转时间短、系统吞吐量高、处理机利用率好

      分时系统目标：响应时间快、均衡性

      实时系统目标：截至时间的保证、可预测性

5. 进程调度算法

   1. 先来先服务

      缺点：没有考虑优先级的问题

   2. 最短进程优先

   3. 最短剩余时间有限算法

   4. 最高响应比优先算法

      响应比RP=1+等待时间/预计运行时间

      总是优先调度响应比最大的进程

   5. 轮转算法

      将处理器划分为一个个的<font color="red">时间片</font>，轮着来

      时间片设置的太短，导致过多的进程切换；太长了导致响应时间变长。合理的时间片20-50ms

   6. 最高优先级算法

      为每一个进程设置一个优先级 ，可以保证紧迫性进程优先进行

   7. 多级反馈队列算法

      结合了先进先出、时间片轮转、可抢占式最高优先级调度算法系统内核

##### 五、内核

​	为了提高系统效率，保护系统关键部分不被破坏，将提供支持系统运行的各种基本操作和基础功能的一组程序模块集中安排，形成一个操作系统的核心，成为系统核心或系统内核
​	内核不是进程，是系统进程和用户进程赖以生存的基础，一般内核常驻内存
​	功能：中断处理程序，进程同步与互斥，进程调度，进程控制与通信，存储与管理 原子操作

## 第四章 进程同步与互斥

#### 进程间的相互作用

##### 一、相关进程和无关进程

1. 相关进程：在逻辑上具有某种联系的进程
2. 无关进程：在逻辑上没有联系的进程

##### 二、与时间有关的错误

​	相关进程在并发运行的时候会交替使用共享资源，可能会形成与时间有关的错误

#### 同步与互斥

##### 一、进程的同步

​	指进程之间一种直接的协同工作关系，一些进程相互合作共同完成一项任务

##### 二、进程的排斥

​	需要共享资源，而这些共享资源往往需要排他性的使用，即一次只能为一个进程服务，因此，各个进程只能互斥使用这些资源，进程间的这种关系就是进程的互斥

##### 三、临界区

1. 临界资源：一次只允许被一个进程使用，则这类资源被称为临界资源或共享变量
2. 临界区：访问临界资源的那段代码或程序
3. 相关临界区：如果有若干进程共享某一临界资源，则该临界区称为相关临界区
4. 使用原则：
   1. 当临界资源空闲时，若有一个进程要求进入临界区，应允许他立即进入。--有空让进，有效的利用资源
   2. 若有一个进程已在玲姐去，其他要求进入临界区的进程必须等待。--无空等待，互斥进入
   3. 当没有进程在临界区，而同时有多个进程要求进入临界区，选择其一进入，其他等待。--多种择一
   4. 任一进入临界区的要求应在有限时间满足---有限等待，避免死等
   5. 处于等待状态的进程应放弃占用处理器。---让权等待，避免忙等

#### 信号量以及P、V操作

同步机制有硬件同步机制、软件同步机制

##### 一、信号量    

1. 信号量：用于表示资源数目的整型量S，除初始化外，仅能通过两个标砖的P操作和V操作来访问。
2. P操作 P(S) V操作V(S)  相当于申请资源并且等待 和释放资源并且唤醒其他的进程
3. 不同资源，用不同的信号表示
   1. S>0 表示某类资源的可用数量
   2. S<0 其绝对值表示排在S等待队列中进程的数量
4. PV操作必须成对出现
5. 互斥操作PV在同一个进程，同步操作时，PV操作出现在不同的进程
6. 既有同步，又有互斥操作时，同步P在前  互斥P操作在后 V操作没关系

##### 二、问题

​	生产者 消费者问题，读者、写者问题

#### 管程

​	信号量以及PV操作的缺点，程序易读性较差，程序不利于修改和维护，正确性难以保证 为了更易于编写正确的程序，引入了管程

​	由一个和过程、变量、以及数据结构组成的一个集合，他们组成了一个特殊的模块或软件包，进程可以在任何需要的时候调佣管程的过程

#### 进程通信

##### 一、共享内存

​	在相互通信的进程之间舍设有一个公共内存区，一组进程向该公共内存中写，另一组进程从公共内存中读，通过这种方式实现两组进程之间的信息交换

##### 二、消息机制

1. 消息缓冲

   进程间的数据交换，是以格式化的消息(也称为报文)为单位的，程序员直接利用操作系统提供的一组通信命令(原语)，实现大量数据的传递，通信过程对用户是透明的

2. 信箱

3. 管道：用于链接一个读进程和一个写进程以实现他们之间通信的一个共享文件，又名pipe文件

## 第五章 死锁

